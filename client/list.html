<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <meta name="google-signin-scope" content="profile email">
  <meta name="google-signin-client_id" content="601481270136-k8nppkr4b3pgnnid05kntlrickot562c.apps.googleusercontent.com">
  <script src="https://apis.google.com/js/platform.js" async defer></script>
</head>
<body>
    <div class="container">
		<!--navbar-->
		<nav class="navbar navbar-expand-lg navbar-light bg-light" id="navbar">
		  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo03" aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
		  </button>
			  <a class="navbar-brand" href="#">ToDo by poll developPoint</a>

			  <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
			  <ul class="navbar-nav mr-auto mt-2 mt-lg-0">

				<li class="nav-item">
				  <a class="nav-link" href="#" onclick="createToDo()" >Create New Todo</a>
				</li>
				<li class="nav-item">
				  <a class="nav-link" href="#" onclick="viewProject()" >Your Project</a>
				</li>
			 </ul>
			 <div class="nav-item">
				<a class="nav-link" href="#" id="signOut" onclick="signOut()">Sign Out</a>
			 </div>
		   </div>
		 </nav>
		<!--end of navbar-->
		
		<!--invitation project-->
		<div id="invitation">
		</div>
		<!--end of invitation project-->
		
		<!--list group-->
		<div class="container-fluid" id="todoList">
			<div class="form-group">
				<h3>Your Personal To Do List ...</h3>
				<div id="list"></div>
			</div>
		</div>
		<!--end of list group-->
		
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script>

    function onLoad() {
      gapi.load('auth2', function () {
        gapi.auth2.init();
      })
    }
    
    //check login
    $(document).ready( function() {
       checkLogin()
	   onLoad()
    })

    function checkLogin(){
       let token = localStorage.getItem('token')
       if ( !token ) {
          window.location='index.html';
       } else {
          listToDo()
       }
    }

    function signOut(){
      console.log(`masuk google log out`)
      localStorage.clear()
      document.location.href = "https://www.google.com/accounts/Logout?continue=https://appengine.google.com/_ah/logout?continue=http://localhost:8080";
      location.reload();
	  let auth2 = gapi.auth2.getAuthInstance();
                auth2.signOut().then(function () {
                console.log('User signed out.');
                });	
    };
	
	function acceptInvitation(id){
	  console.log(`masuk accept invitation`)
		$.ajax({
			method: "PATCH",
			url: "http://localhost:3000/projects/accept",
			data: {projectId: id},
			headers: { jtoken: localStorage.getItem('token') }
		})
		.done(()=> {
		  listToDo()
		})
		.fail(error=> console.log(error))
	}
	
	function rejectInvitation(id){
		$.ajax({
			method: "PATCH",
			url: "http://localhost:3000/projects/reject",
			data: {projectId: id},
			headers: { jtoken: localStorage.getItem('token') }
		})
		.done(()=> {})
		.fail(error=> console.log(error))
	}
	
	 //read all todo
	function listToDo() { 
		console.log(localStorage.getItem('token'))
		$.ajax({
			method: "GET",
			url: "http://localhost:3000/tasks",
			headers: { jtoken: localStorage.getItem('token') }
		})
		.done( result => {
		    console.log(result)
		    let todos= result.task
			let invitationId= result.invitation
			if (invitationId.length > 0){
			    for (let i=0; i< invitationId.length; i++){
				    console.log(invitationId[i])
					$("#invitation").append(`
							<div class="alert alert-warning alert-dismissible fade show" role="alert" >
							  <label>You invited to join ${invitationId[i].title}</label>
							  <button type="button" class="btn btn-success btn-sm" data-dismiss="alert" onclick=acceptInvitation("${invitationId[i]._id}")>Approve</button>
							  <button type="button" class="btn btn-danger btn-sm" data-dismiss="alert" onclick=rejectInvitation("${invitationId[i]._id}")>Reject</button>
							  <button type="button" class="close" data-dismiss="alert" aria-label="Close" >
								<span aria-hidden="true">&times;</span>
							  </button>
							</div>
					`)
				}
			} else {
			
			}
			
			if ( todos.length === 0 ) {
				$( "#list" ).empty()
				$( "#list" ).append(`
					nothing to do, please press insert new "to do" to create one..
				`)
			} else {
				$( "#list" ).empty()
				$( "#list" ).append(`
					Not Done...!!!
					<table class="table table-stripped">
						<thead>
							<tr>
								<!--<th>No.</th>-->
								<th>Name</th>
								<th>Desc</th>
								<th>Days left..</th>
								<th>Target Date</th>
								<th>Status</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody id="notDoneToDo">
						</tbody>
					</table>
				` )
				for ( let i = 0; i < todos.length; i++ ){ 
					if (todos[i].status !== "done"){
						$( "#notDoneToDo" ).append(`
							<tr>
							<!--<td> ${i+1}</td> -->
							<td> ${todos[i].title}</td> 
							<td> ${todos[i].description}</td> 
							<td> ${dateCount(new Date(), todos[i].targetDate)}</td>
							<td> ${formatTanggal(todos[i].targetDate)}</td> 
							<td> ${todos[i].status}</td> 
								<td><button type="button" class="btn btn-success btn-sm mr-2" onclick=changeStatus("${todos[i]._id}")>${labelStatus(todos[i].status)}</button><button class="btn btn-warning btn-sm mr-2" onclick=showEditToDo("${todos[i]._id}")> Edit</button> <button class="btn btn-danger btn-sm" onclick=deleteToDo("${todos[i]._id}")> Delete</button></td>
							</tr>
						` )
					}
				}
				//done
				$( "#list" ).append(`
					Done...
					<table class="table table-stripped">
						<thead>
							<tr>
								<!--<th>No.</th>-->
								<th>Name</th>
								<th>Desc</th>
								<th>Target Date</th>
								<th>It's done on..</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody id="doneToDo"
						</tbody>
					</table>
				` )
				for ( let i = 0; i < todos.length; i++ ){ 
					if (todos[i].status ==="done"){
						$( "#doneToDo" ).append(`
							<tr>
							<!--<td> ${i+1}</td> -->
							<td> ${todos[i].title}</td> 
							<td> ${todos[i].description}</td> 
							<td> ${formatTanggal(todos[i].targetDate)}</td> 
							<td> ${formatTanggal(todos[i].doneDate)}</td> 
								<td><button class="btn btn-warning btn-sm mr-2" onclick=showEditToDo("${todos[i]._id}")> Edit</button> </td>
							</tr>
						` )
					}
				}
			}
		})
		.fail( err => {
			$("#error").text(JSON.stringify(err))
		})
	}
	
	//insert new todo
	function createToDo() { 
		window.location = 'create.html'
	}
	
	//create new project
	function viewProject() { 
		window.location = 'viewProject.html'
	}
	
	function formatTanggal(date) {
		return `${new Date(date).getDate()} - ${new Date(date).getMonth()+1} - ${new Date(date).getFullYear()}`
	}
	
	
	//delete todo
	function deleteToDo(id) { 
		$.ajax({
			method: "DELETE",
			url: `http://localhost:3000/tasks/${id}`,
			headers: { jtoken: localStorage.getItem('token') }
		})
		.done( response => {
			listToDo()
		})
		.fail( err => {
			$("#error").text(JSON.stringify(err))
		})
	}
	
	function showEditToDo(v){
		window.location= `edit.html?id=${v}`
	}

	function changeStatus(id){
                $.ajax({
			method: "PATCH",
			url: `http://localhost:3000/tasks/${id}`,
			headers: {jtoken: localStorage.getItem('token'), projectId: false}
		})
		.done( response => {
			listToDo()
		})
                .fail( err => {
                        $("#error").text(JSON.stringify(err)) 
		})

	}

	function labelStatus(v){
		if(v === 'not done'){
		  return 'done'
		} else {
		  return 'not done'
		}
	}
	
	function dateCount(date1, date2){
	   var timeDiff = Math.abs(new Date(date2).getTime() - date1.getTime());
	   var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24)); 
	   return diffDays
	}
  </script>
</body>
</html>
