<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Arnold's Fancy To-Do List</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="index.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <style>
    table {
        border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
        border: 1px solid #ddd;
    }

    th, td {
        text-align: left;
        padding: 8px;
    }

    tr:nth-child(even){background-color: #f2f2f2}
    </style>

    <script>
        window.fbAsyncInit = function() {
            FB.init({
            appId      : '373279100075221',
            cookie     : true,
            xfbml      : true,
            version    : 'v3.2'
            });
            
            FB.AppEvents.logPageView();   
            
        };
        
        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));


        function checkLoginState() {
            FB.getLoginStatus(function(response) {
                statusChangeCallback(response);
            });
        }

        function statusChangeCallback(response){
            if(response.status === "connected"){
                $.ajax({
                    method: `POST`,
                    data: {token: response.authResponse.accessToken},
                    url: `http://localhost:3000/loginFB`
                }).done(input => {
                    localStorage.setItem("token", input.token)
                    isLogIn()
                    allTasks(input.token)
                }).fail(function(err){
                    alert(err.message)
                })
            }
            else{
                alert("Signed in Failed!")
            }
        }  
    </script>
<body>

    <nav class="navbar navbar-expand-sm bg-dark navbar-dark fixed-on-top">
        <a class="navbar-brand" href="#">To-Do Fancy List</a>
            <ul class="navbar-nav">
                <li class="nav-item">
                <a class="nav-link" id="registerBut" >Register</a>
                </li>
                <li class="nav-item">
                <a class="nav-link" id="signInBut" >Sign In</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" class="options" id="addBut" onclick='showAdd()'>Add New Task</a>
                </li>
            </ul>
    </nav>

<div class="container">
    <form id="login-form" action="https://localhost:3000/signin" method="post" role="form" style="display: block;">
        <h2>Sign In Form</h2>
        <div class="form-group">
            <input type="text" id="email" tabindex="1" class="form-control" placeholder="Email">
        </div>
        <div class="form-group">
            <input type="password" id="password" tabindex="2" class="form-control" placeholder="Password">
        </div>
        <div class="form-group">
            <div class="row">
                <div class="col-sm-6 col-sm-offset-3">
                    <input type="submit" name="login-submit" id="login-submit" tabindex="3" value="Log In">
                </div>
                <fb:login-button class="facebook" scope="public_profile,email" onlogin="checkLoginState();"></fb:login-button>
            </div>
        </div>
    </form>
    <form id="register-form" action="https://localhost:3000/signup" method="post" role="form" style="display: block;">
        <h2>Register Form</h2>
        <div class="form-group">
            <input type="text" name="name" id="nameRegister" tabindex="3" class="form-control" placeholder="Name" required>
        </div>
        <div class="form-group">
            <input type="email" name="email" id="emailRegister" tabindex="4" class="form-control" placeholder="Email Address" required>
        </div>
        <div class="form-group">
            <input type="password" name="password" id="passwordRegister" tabindex="5" class="form-control" placeholder="Password" required>
        </div>
        <div class="form-group">
            <div class="row">
                <div class="col-sm-6 col-sm-offset-3">
                    <input type="submit" name="register-submit" id="register-submit" tabindex="6" value="Register Now">
                </div>
            </div>
        </div>
    </form>
</div>

<form class="newTaskForm">
    <div class="form-group">
        <input type="text" name="name" id="taskName" class="form-control" placeholder="Task Name" required>
    </div>
    <div class="form-group">
        <input type="string" name="email" id="taskDescription" class="form-control" placeholder="Description" required>
    </div>
    <div class="form-group">
        <input type="date" name="dueDate" id="taskDueDate" class="form-control" placeholder="YYYY/MM/DD" required>
    </div>
    <div class="form-group">
        <div class="row">
            <div class="col-sm-6 col-sm-offset-3">
                <input type="submit" id="newTask-submit" value="Add New Task">
            </div>
        </div>
    </div>
</form>

<section class="taskList">
        <table class="taskTable">
                <tr>
                    <th class="headers">Task Name</th>
                    <th class="headers">Description</th>
                    <th class="headers">Status</th>
                    <th class="headers">Due Date</th>
                    <th class="headers">Options</th>
                </tr>
        </table>

</section>


<script>
    $('#register-form').hide()
    $('.taskList').hide()
    $('.newTaskForm').hide()
    $('#addBut').hide()

    $('#registerBut').click(function(event){
        $('#login-form').hide()
        $('#register-form').show()
    })

    $('#signInBut').click(function(event){
        $('#login-form').show()
        $('#register-form').hide()
    })

    $('#login-form').on('submit',function(event){
        event.preventDefault()

        let email = $('#email').val()
        let password = $('#password').val()
        
        $.ajax({
            method: `POST`,
            data: {email, password},
            url: `http://localhost:3000/signin`
        }).done(response => {
            localStorage.setItem("token", response.token)
            isLogIn()
            allTasks(response.token)
        }).fail(err => {
            console.log(err)
        })
    })

    $('#register-form').submit(function(event){
        event.preventDefault()

        let name = $('#nameRegister').val()
        let email = $('#emailRegister').val()
        let password = $('#passwordRegister').val()
        $.ajax({
            url: `http://localhost:3000/signup`,
            method: `POST`,
            data: {name, email, password}
        }).done(user => {
            localStorage.setItem("token", user.token)
        }).fail(err => {
            console.log("ERROR ASU",err)
        })
    })

    $('.newTaskForm').submit(function(event){
        event.preventDefault()
        let name = $('#taskName').val()
        let description = $('#taskDescription').val()
        let dueDate = $('#taskDueDate').val()
        console.log(localStorage.token, "ini token")
        $.ajax({
            method: `POST`,
            data: {token: localStorage.token, name, description, dueDate},
            url: `http://localhost:3000/tasks`
        }).done(response => {
                $('.taskTable').append(`
                <tr>
                    <td>${response.task.name}</td>
                    <td>${response.task.description}</td>
                    <td>${response.task.status}</td>
                    <td>${response.task.dueDate}</td>
                    <td><button onclick="finTask('${task._id}')">Finished</button> <button onclick="delTask('${task._id}')">Delete</button></td>
                </tr>`)
        }).fail(err =>{
            console.log(err)
        })
    })

    function isLogIn(){
        if(localStorage.token){
            $('#registerBut').hide()
            $('#signInBut').hide()
            $('#login-form').hide()
            $('#register-form').hide()
            $('#addBut').show()
            $('.taskList').show()
        }
    }

    function allTasks(token){
        $.ajax({
            method: `POST`,
            data: {token},
            url: `http://localhost:3000/users`
        }).done(response => {
            response.details.forEach(task =>{
                $('.taskTable').append(`
                <tr>
                    <td>${task.name}</td>
                    <td>${task.description}</td>
                    <td>${task.status}</td>
                    <td>${task.dueDate}</td>
                    <td><button onclick="finTask('${task._id}')">Finished</button> <button onclick="delTask('${task._id}')">Delete</button></td>
                </tr>`)
            })
        }).fail(err => {
            console.log(err)
        })
    }

    function finTask(taskId){
        $.ajax({
            method: `PATCH`,
            data: {token: localStorage.token, taskId},
            url: `http://localhost:3000/tasks`
        }).done(response => {
            $('.taskTable').empty()
            $('.taskTable').append(`
                <tr>
                    <th class="headers">Task Name</th>
                    <th class="headers">Description</th>
                    <th class="headers">Status</th>
                    <th class="headers">Due Date</th>
                    <th class="headers">Options</th>
                </tr>`)
            allTasks(localStorage.token)
        }).fail(err =>{
            console.log(err,"Error di edit task")
        })
    }

    function delTask(taskId){
        $.ajax({
            method: `DELETE`,
            data: {token: localStorage.token, taskId},
            url: `http://localhost:3000/tasks`
        }).done(response => {
            $('.taskTable').empty()
            $('.taskTable').append(`
                <tr>
                    <th class="headers">Task Name</th>
                    <th class="headers">Description</th>
                    <th class="headers">Status</th>
                    <th class="headers">Due Date</th>
                    <th class="headers">Options</th>
                </tr>`)
            allTasks(localStorage.token)
        }).fail(err =>{
            console.log(err,"Error di delete task")
        })
    }

    function showAdd(){
        $('.newTaskForm').show()
    }

</script>
</body>
</html>